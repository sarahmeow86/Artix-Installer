#!/usr/bin/env bash
installtz() {
    debug $DEBUG_INFO "Starting timezone configuration"

    debug $DEBUG_DEBUG "Generating region list"
    region_list=$(find /usr/share/zoneinfo -mindepth 1 -maxdepth 1 -type d | sed 's|/usr/share/zoneinfo/||' | sort)

    # Create region selection list
    region_data=""
    for region in $region_list; do
        region_data+="$region!"
    done
    region_data=${region_data%!}

    region=$(yad --list \
        --title="Region Selection" \
        --text="Select your region:" \
        --width=400 \
        --height=400 \
        --column="Region" \
        --separator="" \
        --button="Cancel:1" \
        --button="Select:0" \
        ${region_data})

    if [[ -z "$region" ]]; then
        yad --error \
            --title="Error" \
            --text="No region selected!" \
            --width=300
        error "No region selected!"
    fi

    debug $DEBUG_DEBUG "Selected region: $region"
    debug $DEBUG_DEBUG "Generating city list for region: $region"
    city_list=$(find "/usr/share/zoneinfo/$region" -type f | sed "s|/usr/share/zoneinfo/$region/||" | sort)

    # Create city selection list
    city_data=""
    for city in $city_list; do
        city_data+="$city!"
    done
    city_data=${city_data%!}

    city=$(yad --list \
        --title="City Selection" \
        --text="Select your city in $region:" \
        --width=400 \
        --height=400 \
        --column="City" \
        --separator="" \
        --button="Cancel:1" \
        --button="Select:0" \
        ${city_data})

    if [[ -z "$city" ]]; then
        yad --error \
            --title="Error" \
            --text="No city selected!" \
            --width=300
        error "No city selected!"
    fi

    INST_TZ="/usr/share/zoneinfo/$region/$city"
    debug $DEBUG_INFO "Timezone set to: $region/$city"
    yad --info \
        --title="Timezone Selection" \
        --text="Selected timezone: $region/$city" \
        --width=300
}

installkrn() {
    debug $DEBUG_INFO "Starting kernel selection"

    selected=$(yad --list \
        --title="Kernel Selection" \
        --text="Select the kernel to install:" \
        --width=300 \
        --height=200 \
        --radiolist \
        --column="Select" \
        --column="Kernel" \
        --column="Description" \
        TRUE "linux" "Standard kernel" \
        FALSE "linux-zen" "Zen kernel" \
        FALSE "linux-lts" "Long-term support")

    case $selected in
        linux*) INST_LINVAR="linux" ;;
        *zen*) INST_LINVAR="linux-zen" ;;
        *lts*) INST_LINVAR="linux-lts" ;;
        *) 
            yad --error \
                --title="Error" \
                --text="Invalid kernel selection!" \
                --width=300
            error "Invalid kernel choice!"
            ;;
    esac

    debug $DEBUG_INFO "Kernel selected: $INST_LINVAR"
    yad --info \
        --title="Kernel Selection" \
        --text="Selected kernel: $INST_LINVAR" \
        --width=300
}

selectdisk() {
    debug $DEBUG_INFO "Starting disk selection"
    printf "%s\n" "${bold}## Decide which disk you want to use"

    debug $DEBUG_DEBUG "Generating disk list"
    disk_list=$(ls -1 /dev/disk/by-id | grep -v -- "-part[0-9]")

    # Create disk selection list for YAD
    disk_data=""
    for disk in $disk_list; do
        size=$(lsblk -dno SIZE /dev/disk/by-id/"$disk" 2>/dev/null)
        disk_data+="$disk!$size!"
    done
    disk_data=${disk_data%!}  # Remove trailing delimiter

    selected=$(yad --list \
        --title="Disk Selection" \
        --text="<b>WARNING: THIS WILL DELETE EVERYTHING ON THE SELECTED DRIVE!</b>" \
        --width=600 \
        --height=400 \
        --column="Disk" \
        --column="Size" \
        --separator="" \
        --button="Cancel:1" \
        --button="Select:0" \
        ${disk_data})

    if [[ -z "$selected" ]]; then
        yad --error \
            --title="Error" \
            --text="No disk selected!" \
            --width=300
        error "No disk selected!"
    fi

    DISK="/dev/disk/by-id/${selected}"
    debug $DEBUG_INFO "Disk selected: $DISK"
    yad --info \
        --title="Disk Selection" \
        --text="Selected disk: ${selected}" \
        --width=300
}