#!/usr/bin/env bash
bold=$(tput setaf 2 bold)      # makes text bold and sets color to 2
bolderror=$(tput setaf 3 bold) # makes text bold and sets color to 3
normal=$(tput sgr0)            # resets text settings back to normal

# Function to install ZFS modules
# This function is called before the ZFS root pool and datasets have been created
installzfs() {
    printf "%s\n" "${bold}# Installing the ZFS modules"

    # Get path for ZFS OpenRC package
    local zfs_openrc
    zfs_openrc="$(get_script_path "zfs-openrc-*.pkg.tar.zst" "misc")"

    # Start the progress bar with YAD
    (
        echo "# Installing ZFS packages..."
        echo "10"
        pacman -Sy --noconfirm --needed zfs-dkms-git zfs-utils-git
        
        echo "# Installing ZFS OpenRC package..."
        echo "40"
        pacman -U --noconfirm "$zfs_openrc"
        
        echo "# Loading ZFS kernel module..."
        echo "70"
        modprobe zfs
        
        echo "# Generating hostid..."
        echo "90"
        zgenhostid -f
        echo "100"
    ) | yad --progress \
        --title="ZFS Installation" \
        --text="Installing ZFS modules..." \
        --width=400 \
        --height=100 \
        --auto-close \
        --auto-kill \
        --percentage=0

    # Check if ZFS was installed successfully
    if ! modinfo zfs &>/dev/null; then
        yad --error \
            --title="ZFS Installation Error" \
            --text="Failed to install ZFS modules.\nPlease check the logs for more details." \
            --width=300
        error "Error installing ZFS modules!"
    fi

    yad --info \
        --title="ZFS Installation" \
        --text="ZFS modules installed successfully!" \
        --width=300

    printf "%s\n" "${bold}Done!"
}
