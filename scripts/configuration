#!/usr/bin/env bash
fstab() {
    debug $DEBUG_INFO "Starting fstab generation"
    printf "%s\n" "${bold}Generating fstab"

    (
        echo "# Creating /etc directory..."
        echo "10"
        mkdir -p "$INST_MNT/etc" >> "$LOG_FILE" 2>&1 || error "Failed to create /etc directory!"
        
        if [[ $FILESYSTEM == "btrfs" || $FILESYSTEM == "xfs" || $FILESYSTEM == "ext4" ]]; then
            echo "# Generating fstab with UUIDs..."
            echo "50"
            fstabgen -U "$INST_MNT" >> "$INST_MNT/etc/fstab" 2>> "$LOG_FILE"
        elif [[ $FILESYSTEM == "zfs" ]]; then
            echo "# Adding EFI partition to fstab..."
            echo "50"
            echo "UUID=$(blkid -s UUID -o value ${DISK}-part1) /boot/efi vfat umask=0022,fmask=0022,dmask=0022 0 1" >> "$INST_MNT/etc/fstab" 2>> "$LOG_FILE"
            
            echo "# Adding swap partition to fstab..."
            echo "90"
            echo "UUID=$(blkid -s UUID -o value ${DISK}-part3) none swap defaults 0 0" >> "$INST_MNT/etc/fstab" 2>> "$LOG_FILE"
        fi
        echo "100"
    ) | yad --progress \
        --title="fstab Generation" \
        --text="Generating fstab..." \
        --width=400 \
        --height=100 \
        --auto-close \
        --auto-kill \
        --percentage=0

    # Verify fstab
    debug $DEBUG_DEBUG "Verifying fstab file"
    if [[ ! -f "$INST_MNT/etc/fstab" ]]; then
        debug $DEBUG_ERROR "fstab file not created"
        error "Error generating fstab!"
    fi

    if [[ ! -s "$INST_MNT/etc/fstab" ]]; then
        debug $DEBUG_ERROR "fstab file is empty"
        error "Generated fstab is empty!"
    fi

    debug $DEBUG_INFO "fstab generation completed successfully"
    printf "%s\n" "${bold}fstab generated successfully!"


    yad --info \
        --title="fstab Generation" \
        --text="fstab generated successfully!" \
        --width=300
}

configure_initramfs() {
    debug $DEBUG_INFO "Starting initramfs configuration"
    printf "%s\n" "${bold}Configuring initramfs..."

    (
        echo "# Configuring initramfs..."
        echo "10"
        
        if [[ $FILESYSTEM == "zfs" ]]; then
            echo "# Backing up mkinitcpio.conf..."
            echo "30"
            mv $INST_MNT/etc/mkinitcpio.conf $INST_MNT/etc/mkinitcpio.conf.back >> "$LOG_FILE" 2>&1
            
            echo "# Writing ZFS configuration..."
            echo "50"
            tee $INST_MNT/etc/mkinitcpio.conf >> "$LOG_FILE" 2>&1 <<EOF
HOOKS=(base udev autodetect modconf block keyboard zfs filesystems)
EOF
        fi

        echo "# Regenerating initramfs..."
        echo "80"
        artix-chroot $INST_MNT /bin/bash -c "mkinitcpio -P" >> "$LOG_FILE" 2>&1
        echo "100"
    ) | yad --progress \
        --title="Initramfs Configuration" \
        --text="Configuring initramfs..." \
        --width=400 \
        --height=100 \
        --auto-close \
        --auto-kill \
        --percentage=0

    if [[ $? -ne 0 ]]; then
        debug $DEBUG_ERROR "initramfs regeneration failed"
        error "Error regenerating initramfs!"
    fi

    debug $DEBUG_INFO "initramfs configuration completed"
    printf "%s\n" "${bold}Initramfs configuration completed successfully!"
}


finishtouch() {
    debug $DEBUG_INFO "Starting final system configuration"
    printf "%s\n" "${bold}Finalizing base installation"

    # Start the progress bar
    (
        if [[ -n "$LOCALE" ]]; then
            debug $DEBUG_INFO "Using provided locale: $LOCALE"
            echo "$LOCALE UTF-8" >> $INST_MNT/etc/locale.gen
            echo "LANG=$LOCALE" > $INST_MNT/etc/locale.conf
        else
            debug $DEBUG_DEBUG "Getting locale list"
            locale_list=$(grep -v '^#' /usr/share/i18n/SUPPORTED | cut -d' ' -f1 | sort -u)
            
            selected_locale=$(echo "$locale_list" | yad --list \
                --title="Locale Selection" \
                --text="Choose your locale:" \
                --width=400 \
                --height=400 \
                --column="Locale" \
                --search-column=1 \
                --separator="" \
                --button="Cancel:1" \
                --button="Select:0")

            if [[ -n "$selected_locale" ]]; then
                debug $DEBUG_INFO "Setting locale: $selected_locale"
                echo "$selected_locale UTF-8" >> $INST_MNT/etc/locale.gen
                echo "LANG=$selected_locale" > $INST_MNT/etc/locale.conf
            fi
        fi
        echo "30"
        
        debug $DEBUG_DEBUG "Configuring locale settings"
        echo "en_US.UTF-8 UTF-8" >> $INST_MNT/etc/locale.gen 2>> "$LOG_FILE"
        debug $DEBUG_DEBUG "Running locale-gen"
        artix-chroot $INST_MNT /bin/bash -c locale-gen >> "$LOG_FILE" 2>&1 && echo "100"
    ) | yad --progress \
        --title="System Configuration" \
        --text="Finalizing base installation..." \
        --width=400 \
        --height=100 \
        --auto-close \
        --auto-kill \
        --percentage=0

    if [[ $? -ne 0 ]]; then
        debug $DEBUG_ERROR "Failed to complete base system configuration"
        error "Failed to complete base system configuration!"
    fi

    debug $DEBUG_INFO "Base system configuration completed"
    printf "%s\n" "${bold}Base system configuration completed successfully!"
}

prepare_chroot() {
    debug $DEBUG_INFO "Starting chroot environment preparation"
    printf "%s\n" "${bold}Preparing chroot environment"

    # Get base paths first
    local misc_dir
    misc_dir=$(dirname "$(get_script_path "pacman.conf" "misc")") || error "Failed to find misc directory"
    debug $DEBUG_DEBUG "Misc directory: $misc_dir"

    # Get required paths
    local services_dir="$misc_dir/services"
    local chroot_script=$(get_script_path "artix-chrooting" "scripts")
    
    # Find ZFS OpenRC package
    local zfs_openrc
    zfs_openrc=$(find "$misc_dir" -name "zfs-openrc.pkg.tar.zst" -type f | head -n 1)
    
    if [[ -n "$zfs_openrc" ]]; then
        debug $DEBUG_DEBUG "Found ZFS OpenRC package: $zfs_openrc"
    else
        debug $DEBUG_ERROR "ZFS OpenRC package not found in $misc_dir"
        debug $DEBUG_DEBUG "Files in misc_dir: $(ls -la "$misc_dir")"
        error "ZFS OpenRC package not found. Please ensure zfs-openrc.pkg.tar.zst exists in the misc directory."
    fi

    # Validate paths
    [[ ! -d "$services_dir" ]] && error "Services directory not found: $services_dir"
    [[ ! -f "$chroot_script" ]] && error "Chroot script not found: $chroot_script"
    [[ ! -f "$zfs_openrc" ]] && error "ZFS OpenRC package not found in $misc_dir"

    # Check for package lists
    local pkglists=()
    while read -r pkglist; do
        pkglists+=("$pkglist")
    done < <(find "$misc_dir" -name "pkglist-*.txt" 2>/dev/null)

    if [[ ${#pkglists[@]} -eq 0 ]]; then
        debug $DEBUG_ERROR "No package lists found in $misc_dir"
        error "No package lists found!"
    fi

    debug $DEBUG_DEBUG "Found ${#pkglists[@]} package lists"
    for list in "${pkglists[@]}"; do
        debug $DEBUG_DEBUG "Package list found: $(basename "$list")"
    done

    # Start the progress bar
    (
        echo "# Creating installation directories..."
        echo "10"
        mkdir -p "$INST_MNT/install/services" >> "$LOG_FILE" 2>&1 || error "Failed to create directories!"
        
        echo "# Copying package lists..."
        echo "30"
        for list in "${pkglists[@]}"; do
            cp "$list" "$INST_MNT/install/" >> "$LOG_FILE" 2>&1 || error "Failed to copy package list: $(basename "$list")!"
        done

        debug $DEBUG_DEBUG "Copying service files"
        cp -r "$services_dir"/* "$INST_MNT/install/services/" >> "$LOG_FILE" 2>&1 || error "Failed to copy service files!"
        echo "60"

        if [[ $FILESYSTEM == "zfs" ]]; then
            debug $DEBUG_DEBUG "Copying ZFS OpenRC package"
            if [[ -f "$zfs_openrc" ]]; then
                cp "$zfs_openrc" "$INST_MNT/install/" >> "$LOG_FILE" 2>&1 || error "Failed to copy ZFS OpenRC package!"
            else
                error "ZFS OpenRC package not found! Package path: $zfs_openrc"
            fi
        fi
        echo "80"

        debug $DEBUG_DEBUG "Copying chroot script"
        cp "$chroot_script" "$INST_MNT/install/artix-chrooting" >> "$LOG_FILE" 2>&1 || error "Failed to copy chroot script!"
        chmod +x "$INST_MNT/install/artix-chrooting" >> "$LOG_FILE" 2>&1 || error "Failed to set execute permission!"

        debug $DEBUG_DEBUG "Creating environment file"
        echo "TIMEZONE=$TIMEZONE" > "$INST_MNT/install/chroot.env" 2>> "$LOG_FILE" || error "Failed to create environment file!"
        echo "100"
    ) | yad --progress \
        --title="Chroot Preparation" \
        --text="Preparing chroot environment..." \
        --width=400 \
        --height=100 \
        --auto-close \
        --auto-kill \
        --percentage=0

    if [[ $? -ne 0 ]]; then
        debug $DEBUG_ERROR "Failed to prepare chroot environment"
        error "Failed to prepare chroot environment!"
    fi

    debug $DEBUG_INFO "Chroot environment prepared successfully"
    printf "%s\n" "${bold}Chroot environment prepared successfully!"
}

run_chroot() {
    debug $DEBUG_INFO "Starting chroot installation"
    
    # Show info message
    yad --title="Artix Installation" \
        --text="The final configuration will continue in a terminal window.\nClick OK to proceed." \
        --width=400 \
        --button=OK:0 || exit 1

    # Launch xterm directly
    xterm -geometry 100x30 \
          -title "Artix Installation Configuration" \
          -e "artix-chroot $INST_MNT /bin/bash -c 'source /install/chroot.env && /install/artix-chrooting'" || {
        debug $DEBUG_ERROR "Chroot script failed"
        error "Error running chroot script!"
    }

    debug $DEBUG_INFO "Chroot script completed"
    printf "%s\n" "${bold}Chroot script executed successfully!"
}