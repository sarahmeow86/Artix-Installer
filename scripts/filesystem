#!/usr/bin/env bash
choose_filesystem() {
    FILESYSTEM=$(yad --list \
        --title="Filesystem Selection" \
        --text="Choose your preferred filesystem:" \
        --width=300 \
        --height=200 \
        --radiolist \
        --column="Select" \
        --column="Filesystem" \
        --column="Description" \
        TRUE "ext4" "Standard Linux filesystem" \
        FALSE "btrfs" "Modern CoW filesystem" \
        FALSE "xfs" "High-performance filesystem" \
        FALSE "zfs" "Advanced storage platform" \
        --separator="" \
        --button="Cancel:1" \
        --button="Select:0")

    [[ -z "$FILESYSTEM" ]] && error "No filesystem selected!"
    
    yad --info \
        --title="Filesystem Selection" \
        --text="Selected filesystem: $FILESYSTEM" \
        --width=300
}

setup_filesystem() {
    debug $DEBUG_INFO "Setting up filesystem"
    
    show_progress() {
        yad --progress \
            --title="Filesystem Setup" \
            --text="Setting up $FILESYSTEM filesystem..." \
            --width=400 \
            --height=100 \
            --auto-close \
            --auto-kill \
            --percentage=0
    }
    
    case "$FILESYSTEM" in
        ext4|xfs)
            (
                echo "# Creating mount points..."
                echo "20"
                mkdir -p $INST_MNT
                
                echo "# Formatting root partition..."
                echo "40"
                if [[ $FILESYSTEM == "ext4" ]]; then
                    mkfs.ext4 -F "${DISK}-part2"
                else
                    mkfs.xfs -f "${DISK}-part2"
                fi
                
                echo "# Mounting root partition..."
                echo "60"
                mount "${DISK}-part2" $INST_MNT
                
                echo "# Setting up home partition..."
                echo "80"
                mkfs.ext4 -F "${DISK}-part3"
                mkdir -p $INST_MNT/home
                mount "${DISK}-part3" $INST_MNT/home
                echo "100"
            ) | show_progress
            ;;
            
        btrfs)
            (
                echo "# Creating mount points..."
                echo "10"
                mkdir -p $INST_MNT
                
                echo "# Formatting btrfs partition..."
                echo "30"
                mkfs.btrfs -f "${DISK}-part2"
                mount "${DISK}-part2" $INST_MNT
                
                echo "# Creating subvolumes..."
                echo "50"
                btrfs subvolume create $INST_MNT/@
                btrfs subvolume create $INST_MNT/@cache
                btrfs subvolume create $INST_MNT/@log
                
                echo "# Setting up mounts..."
                echo "70"
                umount $INST_MNT
                mount -o subvol=@ "${DISK}-part2" $INST_MNT
                mkdir -p $INST_MNT/{var/cache,var/log,home}
                mount -o subvol=@cache "${DISK}-part2" $INST_MNT/var/cache
                mount -o subvol=@log "${DISK}-part2" $INST_MNT/var/log
                
                echo "# Setting up home partition..."
                echo "90"
                mkfs.ext4 -F "${DISK}-part3"
                mount "${DISK}-part3" $INST_MNT/home
                echo "100"
            ) | show_progress
            ;;
            
        zfs)
            # ZFS setup is handled by separate functions
            rootpool || error "Error creating ZFS root pool!"
            createdatasets || error "Error creating ZFS datasets!"
            mountall || error "Error mounting ZFS datasets!"
            ;;
            
        *)
            yad --error \
                --title="Filesystem Error" \
                --text="Unsupported filesystem: $FILESYSTEM" \
                --width=300
            error "Unsupported filesystem selected!"
            ;;
    esac

    yad --info \
        --title="Filesystem Setup" \
        --text="Filesystem setup completed successfully!" \
        --width=300
}

