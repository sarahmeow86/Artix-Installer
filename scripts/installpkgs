#!/usr/bin/env bash
installpkgs() {
    debug $DEBUG_INFO "Starting package installation"
    printf "%s\n" "${bold}Installing packages"

    # Get paths for required files
    local pkglist
    local zfs_openrc
    pkglist="$(get_script_path "pkglist.txt" "misc")"
    zfs_openrc="$(get_script_path "zfs-openrc.pkg.tar.zst" "misc")"

    # Start the progress bar
    (
        echo "# Installing base packages..."
        echo "10"
        debug $DEBUG_DEBUG "Installing base packages from pkglist.txt"
        basestrap $INST_MNT - < "$pkglist" >> "$LOG_FILE" 2>&1
        
        echo "# Installing kernel packages..."
        echo "40"
        debug $DEBUG_DEBUG "Installing kernel: $INST_LINVAR"
        basestrap $INST_MNT $INST_LINVAR ${INST_LINVAR}-headers linux-firmware >> "$LOG_FILE" 2>&1
        
        # Install ZFS packages if ZFS is selected
        if [[ $FILESYSTEM == "zfs" ]]; then
            echo "# Installing ZFS packages..."
            echo "70"
            debug $DEBUG_DEBUG "Installing ZFS packages from misc directory"
            basestrap $INST_MNT zfs-dkms-git zfs-utils-git
            debug $DEBUG_DEBUG "Installing ZFS OpenRC package"
            basestrap -U $INST_MNT "$zfs_openrc" >> "$LOG_FILE" 2>&1
        fi
        
        echo "# Configuring pacman..."
        echo "90"
        debug $DEBUG_DEBUG "Copying pacman configuration files"
        rm -rf $INST_MNT/etc/pacman.d >> "$LOG_FILE" 2>&1
        rm $INST_MNT/etc/pacman.conf >> "$LOG_FILE" 2>&1
        cp -r /etc/pacman.d $INST_MNT/etc >> "$LOG_FILE" 2>&1
        cp /etc/pacman.conf $INST_MNT/etc >> "$LOG_FILE" 2>&1
        echo "100"
    ) | yad --progress \
        --title="Package Installation" \
        --text="Installing system packages..." \
        --width=400 \
        --height=100 \
        --auto-close \
        --auto-kill \
        --percentage=0

    # Check if the packages were installed successfully
    if [[ $? -ne 0 ]]; then
        yad --error \
            --title="Installation Error" \
            --text="Failed to install packages.\nCheck the logs for details." \
            --width=300
        error "Error installing packages!"
    fi

    yad --info \
        --title="Package Installation" \
        --text="Packages installed successfully!" \
        --width=300

    debug $DEBUG_INFO "Package installation completed successfully"
    printf "%s\n" "${bold}Packages installed successfully!"
}