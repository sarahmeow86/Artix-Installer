#!/usr/bin/env bash

# YAD helper for progress display
show_progress_pipe() {
    yad --progress \
        --title="ZFS Setup" \
        --width=400 \
        --height=100 \
        --auto-close \
        --auto-kill \
        --text="" \
        --percentage=0
}

check_existing_pools() {
    debug $DEBUG_INFO "Checking for existing ZFS pools"
    local discovered_pools=$(zpool import | grep "pool:" | cut -d: -f2 | tr -d ' ')
    
    if [[ -n "$discovered_pools" ]]; then
        debug $DEBUG_DEBUG "Found existing pools: $discovered_pools"
        if yad --title "Existing ZFS Pools" \
            --text="Found existing ZFS pools:\n\n$discovered_pools\n\nDo you want to import them into the new system?" \
            --button="No:1" --button="Yes:0"; then
            
            debug $DEBUG_INFO "User chose to import existing pools"
            for pool in $discovered_pools; do
                [[ "$pool" == "$ZFS_POOL_NAME" ]] && continue
                debug $DEBUG_DEBUG "Importing pool: $pool to $INST_MNT"
                if ! zpool import -R "$INST_MNT" -N "$pool" >> "$LOG_FILE" 2>&1; then
                    debug $DEBUG_ERROR "Failed to import pool: $pool"
                    error "Failed to import pool: $pool"
                fi
                debug $DEBUG_DEBUG "Mounting datasets for pool: $pool"
                if ! zfs mount -a -l >> "$LOG_FILE" 2>&1; then
                    debug $DEBUG_ERROR "Failed to mount datasets for pool: $pool"
                    error "Failed to mount datasets for pool: $pool"
                fi
                debug $DEBUG_INFO "Successfully imported and mounted pool: $pool"
            done
        else
            debug $DEBUG_INFO "User chose not to import existing pools"
        fi
    else
        debug $DEBUG_DEBUG "No existing pools found"
    fi
}

rootpool() {
    debug $DEBUG_INFO "Starting ZFS root pool creation"
    printf "%s\n" "${bold}Creating root pool"
    yad --title="ZFS Setup" --text="Starting install, it will take time, so go GRUB a cup of coffee! ;D" \
        --timeout=3 --timeout-indicator=bottom

    debug $DEBUG_DEBUG "Using disk: $DISK"
    debug $DEBUG_DEBUG "Using pool name: $ZFS_POOL_NAME"

    (
        echo "# Creating ZFS root pool..."
        echo "10"
        zgenhostid -f
        echo "# Setting up ZFS pool structure..."
        echo "50"
        zpool create -f -o ashift=12 -o autotrim=on -o compatibility=openzfs-2.1-linux \
            -O acltype=posixacl -O xattr=sa -O relatime=on -O compression=lz4 -m none \
            -R $INST_MNT "$ZFS_POOL_NAME" "${DISK}-part2" >> "$LOG_FILE" 2>&1
        echo "# Finalizing setup..."
        echo "100"
    ) | show_progress_pipe

    # Check if the pool was created successfully
    if ! zpool status "$ZFS_POOL_NAME" >> "$LOG_FILE" 2>&1; then
        debug $DEBUG_ERROR "Failed to create ZFS root pool"
        error "Error setting up the root pool!"
    fi

    debug $DEBUG_INFO "Root pool created successfully"
    printf "%s\n" "${bold}Root pool created successfully!"
}

createdatasets() {
    debug $DEBUG_INFO "Starting ZFS dataset creation"
    printf "%s\n" "${bold}Creating root and home datasets"

    (
        echo "# Creating os dataset..."
        echo "10"
        zfs create -o mountpoint=none "$ZFS_POOL_NAME/os" >> "$LOG_FILE" 2>&1
        
        echo "# Creating root filesystem..."
        echo "30"
        zfs create -o mountpoint=/ -o canmount=noauto "$ZFS_POOL_NAME/os/artix" >> "$LOG_FILE" 2>&1
        
        echo "# Creating home dataset..."
        echo "60"
        zfs create -o mountpoint=/home "$ZFS_POOL_NAME/home" >> "$LOG_FILE" 2>&1
        echo "100"
    ) | show_progress_pipe

    # Verify datasets
    debug $DEBUG_DEBUG "Verifying created datasets"
    if ! zfs list "$ZFS_POOL_NAME/os/artix" >> "$LOG_FILE" 2>&1 || 
       ! zfs list "$ZFS_POOL_NAME/home" >> "$LOG_FILE" 2>&1; then
        debug $DEBUG_ERROR "Failed to create ZFS datasets"
        error "Error creating the datasets!"
    fi
    debug $DEBUG_INFO "Datasets created successfully"
    printf "%s\n" "${bold}Datasets created successfully!"
}

mountall() {
    debug $DEBUG_INFO "Starting ZFS dataset mounting"
    printf "%s\n" "${bold}Mounting datasets"

    (
        echo "# Exporting ZFS pool..."
        echo "10"
        zpool export "$ZFS_POOL_NAME" >> "$LOG_FILE" 2>&1
        
        echo "# Importing ZFS pool..."
        echo "30"
        zpool import -N -R "$INST_MNT" "$ZFS_POOL_NAME" >> "$LOG_FILE" 2>&1
        
        echo "# Mounting root dataset..."
        echo "60"
        zfs mount "$ZFS_POOL_NAME/os/artix" >> "$LOG_FILE" 2>&1
        
        echo "# Mounting home dataset..."
        echo "90"
        zfs mount "$ZFS_POOL_NAME/home" >> "$LOG_FILE" 2>&1
        echo "100"
    ) | show_progress_pipe

    # Verify mounts
    debug $DEBUG_DEBUG "Verifying dataset mounts"
    if ! zfs mount | grep -q "$ZFS_POOL_NAME/os/artix" || 
       ! zfs mount | grep -q "$ZFS_POOL_NAME/home"; then
        debug $DEBUG_ERROR "Failed to mount ZFS datasets"
        error "Error mounting datasets!"
    fi

    check_existing_pools

    # Setting cachefile and zgenhostid files
    debug $DEBUG_DEBUG "Setting cachefile and zgenhostid files"
    zpool set cachefile=/etc/zfs/zpool.cache "$ZFS_POOL_NAME" >> "$LOG_FILE" 2>&1 || error "Failed to set cachefile property!"
    if [[ -n "$discovered_pools" ]]; then
    zpool set cachefile=/etc/zfs/zpool.cache "$discovered_pools" >> "$LOG_FILE" 2>&1 || error "Failed to set cachefile property!"
    fi
    mkdir -p "$INST_MNT/etc/zfs" >> "$LOG_FILE" 2>&1 || error "Failed to create /etc/zfs directory!"
    cp /etc/zfs/zpool.cache "$INST_MNT/etc/zfs/zpool.cache" >> "$LOG_FILE" 2>&1 || error "Failed to copy zpool.cache file!"
    cp /etc/hostid "$INST_MNT/etc/hostid" >> "$LOG_FILE" 2>&1 || error "Failed to copy hostid file!"


    debug $DEBUG_INFO "All datasets mounted successfully"
    printf "%s\n" "${bold}All datasets mounted successfully!"
}